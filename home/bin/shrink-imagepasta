#!/usr/bin/env bash
# Resize and shrink clipboard image
set -e

# We use temporary files so we can measure before/after sizes and include a notification preview
INPUT_FILE=$(mktemp --suffix=.png)
OUTPUT_FILE=$(mktemp --suffix=.png)

cleanup() {
    rm -f "$INPUT_FILE" "$OUTPUT_FILE"
}
trap cleanup EXIT

if ! wl-paste  --type "image/png" --no-newline > "$INPUT_FILE" 2>/dev/null; then
    notify-send "Shrink Failed" "Could not paste from clipboard."
    exit 1
fi

SIZE_BEFORE=$(du -h "$INPUT_FILE" | cut -f1)

# PNGs don't have "quality" the way JPEG does, so quality is compression rating (diminishing returns)
magick "$INPUT_FILE" -resize "50%" -strip -quality "95" "$OUTPUT_FILE"

SIZE_AFTER=$(du -h "$OUTPUT_FILE" | cut -f1)

wl-copy --type "image/png" < "$OUTPUT_FILE"

notify-send \
    -i "$OUTPUT_FILE" \
    "Image Shrunk" \
    "Size: $SIZE_BEFORE â†’ $SIZE_AFTER"
